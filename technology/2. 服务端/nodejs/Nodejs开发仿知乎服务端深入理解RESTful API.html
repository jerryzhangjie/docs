<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、项目目标 | 能量蓄水池</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/docs/favicon.svg">
    <meta name="description" content="学习笔记、知识文档、经验总结、生活杂记。">
    
    <link rel="preload" href="/docs/assets/css/0.styles.767e998a.css" as="style"><link rel="preload" href="/docs/assets/js/app.574fc7ba.js" as="script"><link rel="preload" href="/docs/assets/js/2.438c9cc2.js" as="script"><link rel="preload" href="/docs/assets/js/84.9489494e.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.782efd2f.js"><link rel="prefetch" href="/docs/assets/js/11.9a017d0a.js"><link rel="prefetch" href="/docs/assets/js/12.8c3fe05c.js"><link rel="prefetch" href="/docs/assets/js/13.32b8501e.js"><link rel="prefetch" href="/docs/assets/js/14.7cbead99.js"><link rel="prefetch" href="/docs/assets/js/15.5ca6d375.js"><link rel="prefetch" href="/docs/assets/js/16.7b1d893e.js"><link rel="prefetch" href="/docs/assets/js/17.8243e47c.js"><link rel="prefetch" href="/docs/assets/js/18.f795c9b4.js"><link rel="prefetch" href="/docs/assets/js/19.e16fd372.js"><link rel="prefetch" href="/docs/assets/js/20.12825b32.js"><link rel="prefetch" href="/docs/assets/js/21.d2e3ba19.js"><link rel="prefetch" href="/docs/assets/js/22.a091a3f3.js"><link rel="prefetch" href="/docs/assets/js/23.1829b4d2.js"><link rel="prefetch" href="/docs/assets/js/24.41ea6154.js"><link rel="prefetch" href="/docs/assets/js/25.d944d918.js"><link rel="prefetch" href="/docs/assets/js/26.f9ba23ac.js"><link rel="prefetch" href="/docs/assets/js/27.33228142.js"><link rel="prefetch" href="/docs/assets/js/28.cc4b94e6.js"><link rel="prefetch" href="/docs/assets/js/29.e183b477.js"><link rel="prefetch" href="/docs/assets/js/3.ce6400d4.js"><link rel="prefetch" href="/docs/assets/js/30.f2b86e7a.js"><link rel="prefetch" href="/docs/assets/js/31.75faa4ac.js"><link rel="prefetch" href="/docs/assets/js/32.1813d3da.js"><link rel="prefetch" href="/docs/assets/js/33.c64ac273.js"><link rel="prefetch" href="/docs/assets/js/34.d54f07d6.js"><link rel="prefetch" href="/docs/assets/js/35.c6b17c27.js"><link rel="prefetch" href="/docs/assets/js/36.93273509.js"><link rel="prefetch" href="/docs/assets/js/37.f4f46233.js"><link rel="prefetch" href="/docs/assets/js/38.fa9900ec.js"><link rel="prefetch" href="/docs/assets/js/39.3b24b23d.js"><link rel="prefetch" href="/docs/assets/js/4.9b8751d4.js"><link rel="prefetch" href="/docs/assets/js/40.5728cc60.js"><link rel="prefetch" href="/docs/assets/js/41.9e47e643.js"><link rel="prefetch" href="/docs/assets/js/42.2cd430a0.js"><link rel="prefetch" href="/docs/assets/js/43.0e9a4cd9.js"><link rel="prefetch" href="/docs/assets/js/44.ec5e25b6.js"><link rel="prefetch" href="/docs/assets/js/45.4cdd4bf1.js"><link rel="prefetch" href="/docs/assets/js/46.b8a5de46.js"><link rel="prefetch" href="/docs/assets/js/47.544a1352.js"><link rel="prefetch" href="/docs/assets/js/48.75ab366d.js"><link rel="prefetch" href="/docs/assets/js/49.59e58f04.js"><link rel="prefetch" href="/docs/assets/js/5.6d67c780.js"><link rel="prefetch" href="/docs/assets/js/50.96ea067f.js"><link rel="prefetch" href="/docs/assets/js/51.144bb382.js"><link rel="prefetch" href="/docs/assets/js/52.8d9aac06.js"><link rel="prefetch" href="/docs/assets/js/53.06e2c5d4.js"><link rel="prefetch" href="/docs/assets/js/54.2d17b229.js"><link rel="prefetch" href="/docs/assets/js/55.7cda8245.js"><link rel="prefetch" href="/docs/assets/js/56.133756ab.js"><link rel="prefetch" href="/docs/assets/js/57.74959c99.js"><link rel="prefetch" href="/docs/assets/js/58.18ff2b44.js"><link rel="prefetch" href="/docs/assets/js/59.b35de2b8.js"><link rel="prefetch" href="/docs/assets/js/6.c3ae577d.js"><link rel="prefetch" href="/docs/assets/js/60.39380f27.js"><link rel="prefetch" href="/docs/assets/js/61.48b5f2aa.js"><link rel="prefetch" href="/docs/assets/js/62.c62037f3.js"><link rel="prefetch" href="/docs/assets/js/63.a439b062.js"><link rel="prefetch" href="/docs/assets/js/64.c24f247a.js"><link rel="prefetch" href="/docs/assets/js/65.e1fa1286.js"><link rel="prefetch" href="/docs/assets/js/66.313ff872.js"><link rel="prefetch" href="/docs/assets/js/67.b8bfc1ca.js"><link rel="prefetch" href="/docs/assets/js/68.f81bf7a5.js"><link rel="prefetch" href="/docs/assets/js/69.c420ebd2.js"><link rel="prefetch" href="/docs/assets/js/7.5229be7a.js"><link rel="prefetch" href="/docs/assets/js/70.f4bec417.js"><link rel="prefetch" href="/docs/assets/js/71.40db7b8a.js"><link rel="prefetch" href="/docs/assets/js/72.f297dce6.js"><link rel="prefetch" href="/docs/assets/js/73.2d73f227.js"><link rel="prefetch" href="/docs/assets/js/74.735fb235.js"><link rel="prefetch" href="/docs/assets/js/75.50f07148.js"><link rel="prefetch" href="/docs/assets/js/76.89a73abf.js"><link rel="prefetch" href="/docs/assets/js/77.66ba0d1e.js"><link rel="prefetch" href="/docs/assets/js/78.81c41079.js"><link rel="prefetch" href="/docs/assets/js/79.14a4fcbf.js"><link rel="prefetch" href="/docs/assets/js/8.30d4ce7d.js"><link rel="prefetch" href="/docs/assets/js/80.af5d096b.js"><link rel="prefetch" href="/docs/assets/js/81.4eccd1c7.js"><link rel="prefetch" href="/docs/assets/js/82.d069817a.js"><link rel="prefetch" href="/docs/assets/js/83.495cd329.js"><link rel="prefetch" href="/docs/assets/js/85.e4406d55.js"><link rel="prefetch" href="/docs/assets/js/86.71cff966.js"><link rel="prefetch" href="/docs/assets/js/87.5eba7956.js"><link rel="prefetch" href="/docs/assets/js/88.6670820c.js"><link rel="prefetch" href="/docs/assets/js/89.cc537610.js"><link rel="prefetch" href="/docs/assets/js/9.99b7e418.js"><link rel="prefetch" href="/docs/assets/js/90.6ccfe07d.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.767e998a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/favicon.svg" alt="能量蓄水池" class="logo"> <span class="site-name can-hide">能量蓄水池</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/docs/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><span class="title">技术</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术" class="mobile-dropdown-title"><span class="title">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/technology/1. 前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/docs/technology/2. 服务端/" class="nav-link">
  服务端
</a></li><li class="dropdown-item"><!----> <a href="/docs/technology/3. 其它/" class="nav-link">
  其它
</a></li></ul></div></div><div class="nav-item"><a href="/docs/life/" class="nav-link">
  生活杂记
</a></div><div class="nav-item"><a href="/docs/other/" class="nav-link">
  其它
</a></div> <a href="https://github.com/jerryzhangjie/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/docs/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><span class="title">技术</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术" class="mobile-dropdown-title"><span class="title">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/technology/1. 前端/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/docs/technology/2. 服务端/" class="nav-link">
  服务端
</a></li><li class="dropdown-item"><!----> <a href="/docs/technology/3. 其它/" class="nav-link">
  其它
</a></li></ul></div></div><div class="nav-item"><a href="/docs/life/" class="nav-link">
  生活杂记
</a></div><div class="nav-item"><a href="/docs/other/" class="nav-link">
  其它
</a></div> <a href="https://github.com/jerryzhangjie/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>nodejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html" class="active sidebar-link">Nodejs开发仿知乎服务端深入理解RESTful API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#一、项目目标" class="sidebar-link">一、项目目标</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#二、rest" class="sidebar-link">二、REST</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#三、koa" class="sidebar-link">三、Koa</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#四、nosql-数据库" class="sidebar-link">四、NoSQL 数据库</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#五、jwt" class="sidebar-link">五、JWT</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#六、上传图片" class="sidebar-link">六、上传图片</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#七、个人资料" class="sidebar-link">七、个人资料</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#八、关注与粉丝" class="sidebar-link">八、关注与粉丝</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#九、话题接口" class="sidebar-link">九、话题接口</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#十、问题接口" class="sidebar-link">十、问题接口</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#十一、答案接口" class="sidebar-link">十一、答案接口</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#十二、评论接口" class="sidebar-link">十二、评论接口</a></li><li class="sidebar-sub-header"><a href="/docs/technology/2. 服务端/nodejs/Nodejs开发仿知乎服务端深入理解RESTful API.html#十三、阿里云安装git和node" class="sidebar-link">十三、阿里云安装Git和Node</a></li></ul></li><li><a href="/docs/technology/2. 服务端/nodejs/基础.html" class="sidebar-link">基础</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一、项目目标"><a href="#一、项目目标" class="header-anchor">#</a> 一、项目目标</h2> <ul><li>理解 RESTful API 的 6 个限制和若干最佳实践</li> <li>掌握 Koa2、Postman、MongoDB、JWT 等技术</li> <li>运用上述技术搭建仿知乎 RESTful API</li> <li>掌握阿里云线上部署方法</li></ul> <h2 id="二、rest"><a href="#二、rest" class="header-anchor">#</a> 二、REST</h2> <h3 id="what"><a href="#what" class="header-anchor">#</a> what</h3> <ul><li>万维网软件架构风格</li> <li>用来创建网络服务</li></ul> <h3 id="why"><a href="#why" class="header-anchor">#</a> Why</h3> <ul><li><strong>Re</strong>presentational <strong>S</strong>tate <strong>T</strong>ransfer   -  数据在互联网传输时的表现形式</li> <li>Representational 数据的表现形式(JSON、XML...)</li> <li>State 当前的状态或者数据</li> <li>Transfer 数据传输</li></ul> <h3 id="_6个限制"><a href="#_6个限制" class="header-anchor">#</a> 6个限制</h3> <h4 id="_1-客户端-服务端-client-server"><a href="#_1-客户端-服务端-client-server" class="header-anchor">#</a> 1. 客户端-服务端（Client-Server）</h4> <ul><li>关注点分离</li> <li>服务端专注数据存储，提升了简单性</li> <li>前端专注于用户界面，提升了可移植性</li></ul> <h4 id="_2-无状态"><a href="#_2-无状态" class="header-anchor">#</a> 2. 无状态</h4> <ul><li>所有用户会话信息都保存在客户端</li> <li>每次请求必须包括所有信息，不能依赖上下文信息</li> <li>服务端不用保存会话信息，提升了简单性、可靠性、可见性</li></ul> <h4 id="_3-缓存"><a href="#_3-缓存" class="header-anchor">#</a> 3. 缓存</h4> <ul><li>所有服务端响应都要被标为可缓存或不可缓存</li> <li>减少前后端交互，提升了性能</li></ul> <h4 id="_4-统一接口-重要"><a href="#_4-统一接口-重要" class="header-anchor">#</a> 4. 统一接口（重要）</h4> <ul><li>接口设计尽可能统一通用，提升了简单性、可见性</li> <li>接口与实现解耦，使前后端可以独立开发迭代</li></ul> <h4 id="_5-分层系统"><a href="#_5-分层系统" class="header-anchor">#</a> 5. 分层系统</h4> <ul><li>每层只知道相邻的一层，后面隐藏的就不知道了</li> <li>客户端不知道是和代理还是真实服务器通信</li> <li>其它层：安全层、负载均衡层、缓存层等</li></ul> <h4 id="_6-按需代码-可选"><a href="#_6-按需代码-可选" class="header-anchor">#</a> 6. 按需代码（可选）</h4> <ul><li>客户端可以下载运行服务端传来的代码（比如 JS 代码，通过 eval 执行）</li> <li>通过减少一些功能，简化了客户端</li></ul> <h3 id="统一接口的限制"><a href="#统一接口的限制" class="header-anchor">#</a> 统一接口的限制</h3> <h4 id="_1-资源的标识"><a href="#_1-资源的标识" class="header-anchor">#</a> 1. 资源的标识</h4> <ul><li>资源是任何可以命名的事物，比如用户、评论等</li> <li>每个资源可以通过 URI 被唯一的标识</li></ul> <h4 id="_2-通过表述来操作资源"><a href="#_2-通过表述来操作资源" class="header-anchor">#</a> 2. 通过表述来操作资源</h4> <ul><li>表述是 Representation，比如 JSON、XML等</li> <li>客户端不能直接操作（比如通过 SQL）服务端资源</li> <li>客户端应该通过表述（比如 JSON）来操作资源</li></ul> <h4 id="_3-自描述消息"><a href="#_3-自描述消息" class="header-anchor">#</a> 3. 自描述消息</h4> <ul><li>每个消息（请求或响应）必须提供足够的信息让接受者理解</li> <li>媒体类型（application/json、application/xml）</li> <li>HTTP 方法：GET（查）、POST（增）、DELETE（删）</li> <li>是否缓存（Cache-Control）</li></ul> <h4 id="_4-超媒体作为应用状态引擎"><a href="#_4-超媒体作为应用状态引擎" class="header-anchor">#</a> 4. 超媒体作为应用状态引擎</h4> <ul><li>点击链接跳转到另一个网页</li></ul> <h3 id="restful-api"><a href="#restful-api" class="header-anchor">#</a> RESTful API</h3> <h4 id="_1-组成"><a href="#_1-组成" class="header-anchor">#</a> 1. 组成</h4> <ul><li>基本的 URI</li> <li>标准的 HTTP 方法，如 GET、POST、PUT等</li> <li>传输的数据的媒体类型，如 JSON、XXML</li></ul> <h4 id="_2-设计规范"><a href="#_2-设计规范" class="header-anchor">#</a> 2. 设计规范</h4> <ul><li>URI 使用名词，尽量用复数，如 /users</li> <li>URI 使用嵌套表示关联关系，如 /users/12/repos/5</li> <li>使用正确的 HTTP 方法，如 GET/POST/PUT/DELETE</li> <li>不符合 CRUD 的情况：POST+动词/action/子资源</li></ul> <h4 id="_3-响应设计规范"><a href="#_3-响应设计规范" class="header-anchor">#</a> 3. 响应设计规范</h4> <ul><li>查询，可通过参数限定数据范围</li> <li>分页</li> <li>字段过滤，可通过指定字段限定返回哪些字段</li> <li>状态码</li> <li>错误处理信息</li> <li>增删改查返回响应：(最佳实践)
<ul><li>查 - 查找的内容</li> <li>增、改 - 增、改的内容</li> <li>删 - 204状态码</li></ul></li></ul> <h4 id="_4-安全"><a href="#_4-安全" class="header-anchor">#</a> 4. 安全</h4> <ul><li>HTTPS</li> <li>鉴权，通过登录获取用户信息</li> <li>限流，请求头部记录请求次数，超过限额时报错</li></ul> <h4 id="_5-开发者友好"><a href="#_5-开发者友好" class="header-anchor">#</a> 5. 开发者友好</h4> <ul><li>API 文档</li> <li>超媒体</li></ul> <h2 id="三、koa"><a href="#三、koa" class="header-anchor">#</a> 三、Koa</h2> <h3 id="_1-一句话简介"><a href="#_1-一句话简介" class="header-anchor">#</a> 1. 一句话简介</h3> <p>基于 Node.js 的下一代 Web 框架</p> <h3 id="_2-洋葱模型"><a href="#_2-洋葱模型" class="header-anchor">#</a> 2. 洋葱模型</h3> <ul><li>async、await</li> <li>ctx、next</li></ul> <h3 id="_3-常用-koa-中间件"><a href="#_3-常用-koa-中间件" class="header-anchor">#</a> 3. 常用 koa 中间件</h3> <ul><li>nodemon	-	热更新</li> <li>koa-router  -    路由（需实例化 new Router()，并注册到koa上 app.use(router.routes())）</li> <li>Koa-bodyparser   -   获取请求体，仅支持 JSON 和 form 格式的请求体</li> <li>koa-body  - 获取请求体，不仅支持 JSON 和 form，还支持文件格式，可以应对文件(图片等)上传的场景</li> <li>Koa-static - 生成一个静态服务，可通过配置，指定一个文件夹作为静态服务的目标目录，然后就可以通过http访问到该文件夹下的文件了</li> <li>Koa-json-error  -   错误处理</li> <li>Cross-env   -   跨平台设置环境变量</li> <li>Koa-parameter  -  校验请求参数</li> <li>Mongoose  -  连接mongodb数据库</li> <li>jsonwebtoken  -  生成JWT以及验证</li> <li>koa-jwt  -  用户认证和授权</li></ul> <h3 id="_4-常用状态码"><a href="#_4-常用状态码" class="header-anchor">#</a> 4. 常用状态码</h3> <ul><li>404 请求不存在</li> <li>405 请求方法不允许（有能力实现，但是不允许你这样请求，例如 koa-router 有能力实现 put 方法，但是不允许这个接口这样用）</li> <li>501 请求方法不支持（没有能力支持该请求方法，例如 koa-router 仅支持常用方法，无法支持 link 等不常用方法）</li> <li>412 先决条件失败（如 路由参数值超出有效范围）</li> <li>500 运行时错误（如  a.b a为undefined）</li> <li>422 无法处理的实体（请求参数校验未通过）</li> <li>409 已存在，导致冲突</li> <li>401 不存在</li> <li>403 未授权</li></ul> <h3 id="_5-路由存在的意义"><a href="#_5-路由存在的意义" class="header-anchor">#</a> 5. 路由存在的意义</h3> <ul><li>处理不同的 URL</li> <li>处理不同的 HTTP 方法</li> <li>解析 URL 上的参数</li></ul> <h3 id="_6-http-options-方法"><a href="#_6-http-options-方法" class="header-anchor">#</a> 6. http options 方法</h3> <p>作用：</p> <ul><li>检测接口所支持的请求方法</li> <li>CORS 中的预检请求</li></ul> <p>koa-router 中的 allowedMethods 方法的作用：</p> <ul><li>响应 options 方法，返回该接口所支持的请求方法</li> <li>相应地返回 405（不允许）和 501（没实现）</li></ul> <h3 id="_7-控制器"><a href="#_7-控制器" class="header-anchor">#</a> 7. 控制器</h3> <ul><li>拿到路由分配的任务，并执行</li> <li>在 koa 中，控制器是中间件</li> <li>获取 HTTP 请求参数</li> <li>处理业务逻辑</li> <li>发送 HTTP 响应</li></ul> <h3 id="_8-获取-http-请求参数"><a href="#_8-获取-http-请求参数" class="header-anchor">#</a> 8. 获取 HTTP 请求参数</h3> <ul><li>Query String，如 ?q=keyword，往往是可选的参数，长度有限制，不安全</li> <li>Router Parames，如 /users/:id，路由参数是必选的</li> <li>Body，如 { name: 'lilei' }</li> <li>Header，如 Accept、Cookie</li></ul> <h3 id="_9-发送-http-响应"><a href="#_9-发送-http-响应" class="header-anchor">#</a> 9. 发送 HTTP 响应</h3> <ul><li>发送 Status，如 200/400 等</li> <li>发送 Body，如 { name: 'lilei' }</li> <li>发送 Header，如 Allow、Content-Type</li></ul> <h3 id="_10-编写控制器的最佳实践"><a href="#_10-编写控制器的最佳实践" class="header-anchor">#</a> 10. 编写控制器的最佳实践</h3> <ul><li>每个资源的控制器放在不同的文件里</li> <li>尽量使用类 + 类方法的形式编写控制器</li> <li>严谨的错误处理</li></ul> <h3 id="_11-vs-code-断点调试"><a href="#_11-vs-code-断点调试" class="header-anchor">#</a> 11. Vs code 断点调试</h3> <ul><li>打开带执行代码，点击 F5</li> <li>在需要断点处设置断点</li> <li>请求接口，查看断点处参数</li></ul> <h3 id="_12-异常状况有哪些"><a href="#_12-异常状况有哪些" class="header-anchor">#</a> 12. 异常状况有哪些</h3> <ul><li>运行时错误，都返回 500</li> <li>逻辑错误，如 找不到（404）、先决条件失败（412）、无法处理的实体（参数格式不对，422）等</li></ul> <h2 id="四、nosql-数据库"><a href="#四、nosql-数据库" class="header-anchor">#</a> 四、NoSQL 数据库</h2> <h3 id="_1-分类"><a href="#_1-分类" class="header-anchor">#</a> 1. 分类</h3> <ul><li>列存储（HBase）</li> <li>文档存储（MongoDB）- 按JSON存储</li> <li>Key-Value存储（Redis）</li> <li>图存储（FlockDB）</li> <li>对象存储（db4o）</li> <li>XML存储（BaseX）</li></ul> <h3 id="_2-特点"><a href="#_2-特点" class="header-anchor">#</a> 2. 特点</h3> <ul><li>简单（没有原子性、一致性、隔离性等复杂规范）</li> <li>便于横向拓展</li> <li>适合超大规模数据的存储</li> <li>很灵活的存储复杂结构的数据（Schema Free）</li></ul> <h3 id="_3-mongodb"><a href="#_3-mongodb" class="header-anchor">#</a> 3. MongoDB</h3> <h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <ul><li>性能好（内存计算）</li> <li>支持大规模数据存储（可拓展性好）</li> <li>可靠安全（本地复制、自动故障转移）</li> <li>方便存储复杂数据结构（Schema Free ）</li></ul> <h4 id="安装-云mongodb-mongodb-atlas"><a href="#安装-云mongodb-mongodb-atlas" class="header-anchor">#</a> 安装 ——&gt; 云MongoDB ——&gt; MongoDB Atlas</h4> <ul><li>注册用户</li> <li>创建集群(包含很多集合)</li> <li>添加数据库用户</li> <li>设置IP地址白名单</li> <li>获取连接地址</li></ul> <p>MongoDB Atlas 账号 z_jerry2016@163.com 集群 zhihu  数据库用户 jerry 密码 jerry123</p> <h4 id="mongoose-连接-mongodb"><a href="#mongoose-连接-mongodb" class="header-anchor">#</a> Mongoose 连接 MongoDB</h4> <ul><li>连接	.connect()</li> <li>创建 Schema    new Schema()</li> <li>创建集合    model('User', userSchema)</li> <li>增删改查
<ul><li>查    .find()</li> <li>查找特定    findById</li> <li>增    new User(ctx.request.body).save()</li> <li>改    findByIdAndUpdate</li> <li>删    findByIdAndRemove</li></ul></li></ul> <h2 id="五、jwt"><a href="#五、jwt" class="header-anchor">#</a> 五、JWT</h2> <h3 id="_1-session"><a href="#_1-session" class="header-anchor">#</a> 1. Session</h3> <ul><li>认证：让服务器知道你是谁</li> <li>授权：服务器授予的什么能做什么不能做的权利</li> <li>原理：
<ul><li>客户端向服务端发送用户名、密码等信息请求登录</li> <li>服务端接收到用户名、密码并查询数据库获取其它用户信息(认证、授权等)，用这些信息生成Session数据存入内存或内存数据库(例如radis)中，每条Session数据对应一个Session ID，服务端向客户端发送Session ID（有时会将整个Session数据加密成Session ID，从而无需保存在服务端，就可直接从SessionID中解密出用户信息）</li> <li>客户端将Session ID存在Cookie中，每次发送请求都会自动携带Cookie中的Session ID</li> <li>服务端接收到Session ID，会到内存或内存数据库(例如radis)中查找对应的Session数据，并解析出用户信息，从而获取认证、授权等信息，最后对请求进行响应</li> <li>客户端想退出登录：仅需删除Cookie中的Session ID即可</li> <li>服务端想强制用户退出：仅需删除内存或内存数据库(例如radis)中的Session数据即可</li></ul></li> <li>优势：
<ul><li>相比于JWT(仅将Token存在客户端)，最大优势在于服务端可以主动清楚Session(因为Session数据存在服务端)</li> <li>session数据保存在服务端，相对较安全</li> <li>结合Cookie使用，较为灵活，兼容性较好</li></ul></li> <li>劣势：
<ul><li>Session + Cookie 在跨域场景下表现不好</li> <li>如果是分布式部署，需要做多机共享Session机制</li> <li>基于Cookie的机制很容易被CSRF</li> <li>查询Session信息可能会有数据库查询操作，带来性能问题</li></ul></li></ul> <h3 id="_2-jwt"><a href="#_2-jwt" class="header-anchor">#</a> 2. JWT</h3> <ul><li>Json Web Token是一个开放标准</li> <li>定义了一种紧凑且独立的方式，可以将各方之间的信息作为JSON对象进行传输</li> <li>该JSON对象是可以被验证和信任的，因为是经过数字签名的</li> <li>构成：
<ul><li>头部（Header）：token方式、加密算法</li> <li>有效载荷（payload）：有效信息，进行base64UrlEncode()编码，可加密</li> <li>签名（Signature）：对Header和Payload部分进行签名，保证token在传输的过程中没有被篡改或者损坏</li></ul></li> <li>工作原理：
<ul><li>客户端向服务端发送用户名、密码等信息请求登录</li> <li>服务端接收到用户名、密码并查询数据库获取其它用户信息(认证、授权等)，并将这些信息作为JWT的Payload，连同Header一起进行编码和加密，并添加Signature形成JWT，作为响应结果返回给客户端</li> <li>客户端接收到JWT后，保存在 SessionStorage或者LocalStorage中，之后每次发送请求都会在请求头中以 Authorization: Bearer ...JWT... 的形式携带JWT信息</li> <li>服务端接收到JWT，进行解密解码并验证有效性获知用户信息，并返回请求结果</li> <li>客户端想退出登录：仅需删除SessionStorage或者LocalStorage中的Session ID即可</li> <li>由于JWT保存在客户端，服务端无法强制客户端退出登录</li></ul></li> <li>JWT vs. Session
<ul><li>可拓展性(横向拓展)	JWT更优</li> <li>安全性
<ul><li>xss  js可修改sessionStorage、localStorage中的JWT，可通过签名和加密来防范</li> <li>CSRF 跟cookie相关</li> <li>中间人攻击  使用https来防范</li></ul></li> <li>RESTful API  其中一个限制是“无状态”，所以选择JWT而不是Session</li> <li>性能
<ul><li>JWT 传输数据量大，相比Session是通过空间换取时间</li> <li>Session 需要通过SessionId查询数据库获取真实信息</li></ul></li> <li>时效性
<ul><li>JWT时效性差，因为对于服务端，只能等到过期时间JWT才会销毁，而Session保存在服务端，服务端可以主动销毁</li></ul></li></ul></li> <li>Node 中使用 JWT
<ul><li>jsonwebtoken 的基本使用
<ul><li>生成 token =  jwt.sign({name: 'jerry', age: '18'}, 'secret')</li> <li>验证 jwt.verify(token, secret)</li></ul></li> <li>Koa-jwt 内置了 jsonwebtoken，使用更便捷</li></ul></li></ul> <h2 id="六、上传图片"><a href="#六、上传图片" class="header-anchor">#</a> 六、上传图片</h2> <h3 id="_1-功能点"><a href="#_1-功能点" class="header-anchor">#</a> 1. 功能点</h3> <ul><li>基本功能：上传图片、生成图片链接</li> <li>附加功能：限制上传图片的大小与类型、生成高中低三种分辨率的图片链接、生成CND</li></ul> <h3 id="_2-koa-static-生成一个静态服务"><a href="#_2-koa-static-生成一个静态服务" class="header-anchor">#</a> 2. Koa-static - 生成一个静态服务</h3> <h2 id="七、个人资料"><a href="#七、个人资料" class="header-anchor">#</a> 七、个人资料</h2> <h3 id="_1-schema设计"><a href="#_1-schema设计" class="header-anchor">#</a> 1. schema设计</h3> <h3 id="_2-参数校验"><a href="#_2-参数校验" class="header-anchor">#</a> 2. 参数校验</h3> <h3 id="_3-字段过滤"><a href="#_3-字段过滤" class="header-anchor">#</a> 3. 字段过滤</h3> <ul><li>设计 schema 默认隐藏部分字段</li> <li>通过查询字符串显示隐藏字段</li></ul> <h2 id="八、关注与粉丝"><a href="#八、关注与粉丝" class="header-anchor">#</a> 八、关注与粉丝</h2> <h3 id="_1-需求分析"><a href="#_1-需求分析" class="header-anchor">#</a> 1. 需求分析</h3> <ul><li>关注、取消关注</li> <li>获取关注人、粉丝列表（用户-用户 多对多关系）</li></ul> <h3 id="_2-schema-设计"><a href="#_2-schema-设计" class="header-anchor">#</a> 2. schema 设计</h3> <ul><li>mongoDB 规定一行数据量超过 4M 就代表数据结构设计不合理</li> <li>一个用户可以关注多个用户（1对多），一个用户也可以被多个用户关注（多对1）。设想，一个大V可能有100万粉丝，显然按多对1设计会存在数据量过大的问题，但一个用户关注的用户量不会很多(顶多关注几千个)，所以按1对多来设计比较合理。</li> <li>基于1对多的数据结构，获取粉丝即可变相的请求“关注了我的用户”</li></ul> <h3 id="_3-接口实现"><a href="#_3-接口实现" class="header-anchor">#</a> 3. 接口实现</h3> <ul><li>获取关注人(关注了谁)、粉丝列表接口</li> <li>关注、取消关注接口</li></ul> <h2 id="九、话题接口"><a href="#九、话题接口" class="header-anchor">#</a> 九、话题接口</h2> <h3 id="_1-需求分析-2"><a href="#_1-需求分析-2" class="header-anchor">#</a> 1. 需求分析</h3> <ul><li>话题的增改查</li> <li>分页、模糊搜索</li> <li>用户属性中的话题引用</li> <li>关注/取消关注话题、用户关注的话题列表</li></ul> <h3 id="_2-schema-设计-2"><a href="#_2-schema-设计-2" class="header-anchor">#</a> 2. schema 设计</h3> <h3 id="_3-分页"><a href="#_3-分页" class="header-anchor">#</a> 3. 分页</h3> <ul><li>query传参</li> <li>mongoose 的语法糖 limit() 和 skip() 可实现分页</li></ul> <h3 id="_4-模糊搜索"><a href="#_4-模糊搜索" class="header-anchor">#</a> 4. 模糊搜索</h3> <ul><li>query传参</li> <li>mongoose 的语法糖 正则表达式</li></ul> <h3 id="_5-话题关注与取消关注接口"><a href="#_5-话题关注与取消关注接口" class="header-anchor">#</a> 5. 话题关注与取消关注接口</h3> <ul><li>用户-话题多对多关系</li></ul> <h2 id="十、问题接口"><a href="#十、问题接口" class="header-anchor">#</a> 十、问题接口</h2> <h3 id="_1-一对多接口设计"><a href="#_1-一对多接口设计" class="header-anchor">#</a> 1. 一对多接口设计</h3> <h3 id="_2-话题-问题多对多关系设计与实现"><a href="#_2-话题-问题多对多关系设计与实现" class="header-anchor">#</a> 2. 话题 - 问题多对多关系设计与实现</h3> <ul><li>问题的话题列表
<ul><li>一个问题的话题是有限的，但话题的问题可能是非常多的，所以我们在问题Model的Schema中添加 topics字段</li></ul></li> <li>话题的问题列表</li></ul> <h2 id="十一、答案接口"><a href="#十一、答案接口" class="header-anchor">#</a> 十一、答案接口</h2> <h3 id="_1-功能点-2"><a href="#_1-功能点-2" class="header-anchor">#</a> 1. 功能点</h3> <ul><li>增删改查</li> <li>问题-答案/用户-答案——一对多</li> <li>赞/踩答案</li> <li>收藏答案</li></ul> <h3 id="_2-二级嵌套的增删改查"><a href="#_2-二级嵌套的增删改查" class="header-anchor">#</a> 2. 二级嵌套的增删改查</h3> <h3 id="_3-互斥关系的赞-踩答案接口设计与实现"><a href="#_3-互斥关系的赞-踩答案接口设计与实现" class="header-anchor">#</a> 3. 互斥关系的赞/踩答案接口设计与实现</h3> <h2 id="十二、评论接口"><a href="#十二、评论接口" class="header-anchor">#</a> 十二、评论接口</h2> <h3 id="_1-三级嵌套的增删改查"><a href="#_1-三级嵌套的增删改查" class="header-anchor">#</a> 1. 三级嵌套的增删改查</h3> <h3 id="_2-一级评论、二级评论"><a href="#_2-一级评论、二级评论" class="header-anchor">#</a> 2. 一级评论、二级评论</h3> <h2 id="十三、阿里云安装git和node"><a href="#十三、阿里云安装git和node" class="header-anchor">#</a> 十三、阿里云安装Git和Node</h2> <h3 id="_1-登录阿里云服务器"><a href="#_1-登录阿里云服务器" class="header-anchor">#</a> 1. 登录阿里云服务器</h3> <p>命令行输入 ssh 服务器用户名@公网IP</p> <h3 id="_2-下载git"><a href="#_2-下载git" class="header-anchor">#</a> 2. 下载Git</h3> <p>查看git官网，不同服务器系统的安装方式不同</p> <h3 id="_3-将代码克隆到服务器"><a href="#_3-将代码克隆到服务器" class="header-anchor">#</a> 3. 将代码克隆到服务器</h3> <p>git clone 代码的http地址</p> <h3 id="_4-服务器上安装-node-js"><a href="#_4-服务器上安装-node-js" class="header-anchor">#</a> 4. 服务器上安装 node.js</h3> <p>使用NodeSource(github搜索)</p> <h3 id="_5-用-nginx-实现端口转发"><a href="#_5-用-nginx-实现端口转发" class="header-anchor">#</a> 5. 用 nginx 实现端口转发</h3> <p>外网3000端口不开放，无法访问3000端口。外网只开放了80端口，但我的程序无法绑定到80端口，此时可用nginx将外网的80端口转发到内网的3000端口上。</p> <ul><li><p>安装 nginx</p></li> <li><p>配置 nginx，把外网80端口转发到内网3000端口</p> <ul><li>vim 配置文件。  打开配置文件</li> <li>i。进入编辑状态</li> <li>esc按键。退出编辑状态</li> <li>:wq。保存并退出</li></ul></li> <li><p>检查配置是否有误</p> <p>nginx -t</p></li> <li><p>重启nginx</p> <p>Service nginx rstart 或 service nginx reload</p></li></ul> <h3 id="_6-使用-pm2-管理进程-守护进程"><a href="#_6-使用-pm2-管理进程-守护进程" class="header-anchor">#</a> 6. 使用 PM2 管理进程(守护进程)</h3> <ul><li>安装 PM2。  npm i pm2 -g</li> <li>使用pm2启动程序。pm2 start app</li> <li>停止程序。pm2 stop app</li> <li>重启重启。pm2 restart app.  pm2 reload app</li> <li>添加环境变量。NODE_ENV=production pm2 start app --update-env</li> <li>查看日志  pm2 log</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">3/28/2021, 9:04:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/technology/2. 服务端/nodejs/基础.html">
        基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.574fc7ba.js" defer></script><script src="/docs/assets/js/2.438c9cc2.js" defer></script><script src="/docs/assets/js/84.9489494e.js" defer></script>
  </body>
</html>
